name: Flux Bootstrap

on:
  workflow_dispatch:
    inputs:
      cluster-name:
        description: 'EKS Cluster Name'
        required: true
        default: 'demo-eks'

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    environment: int
    permissions:
      id-token: write
      contents: read
    env:
      GITHUB_USERNAME: ${{ secrets.FLUX_GIT_USER }}
      GITHUB_PAT: ${{ secrets.FLUX_GIT_PAT }}
      AWS_ROLE_TO_ASSUME: ${{ secrets.GIT_ROLE_ARN }}
      AWS_REGION: eu-central-1
      KUBECONFIG: /tmp/kubeconfig
      GIT_REPOSITORY: ci-cd-gitops


    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install Flux CLI
        run: curl -s https://fluxcd.io/install.sh | sudo bash

      - name: Configure kubeconfig
        run: aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Bootstrap Flux
        run: |
          flux bootstrap github \
            --components-extra image-reflector-controller,image-automation-controller
            --owner=${{ env.GITHUB_USERNAME }} \ 
            --repository=${{ env.GIT_REPOSITORY }}  \
            --branch=main \
            --path=project/clusters/demo \
            --personal \
            --token-auth
# --token-auth uses the PAT stored in GITHUB_PAT
#  --components-extra image-reflector-controller,image-automation-controller for image repository manual update!